<%- include('../partials/header') %>

<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
  <div class="px-4 py-6 sm:px-0">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">User Management</h1>

    <!-- Search Form -->
    <form method="GET" class="mb-8 flex gap-4">
      <input
        type="text"
        name="search"
        value="<%= search %>"
        placeholder="Search users..."
        class="flex-1 border-gray-300 rounded-md shadow-sm px-4 py-2"
      />
      <select
        name="searchBy"
        class="border-gray-300 rounded-md shadow-sm px-4 py-2"
      >
        <option value="name" <%= searchBy === 'name' ? 'selected' : '' %>>
          Search by Name
        </option>
        <option value="phone" <%= searchBy === 'phone' ? 'selected' : '' %>>
          Search by Phone
        </option>
      </select>
      <button
        type="submit"
        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700"
      >
        Search
      </button>
    </form>

    <% if (successMessage) { %>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
      <%= successMessage %>
    </div>
    <% } %>

    <% if (errorMessage) { %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <%= errorMessage %>
    </div>
    <% } %>

    <!-- Users Table -->
    <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Name
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Email
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Phone
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Role
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Status
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% users.forEach(user => { %>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">
                <%= user.fullName %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500"><%= user.email %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500"><%= user.phone %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <%= user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800' %>">
                <%= user.role %>
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <%= user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                <%= user.active ? 'Active' : 'Inactive' %>
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex space-x-3">
                <!-- Toggle Status -->
                <form action="/admin/users/<%= user.id %>/toggle" method="POST" class="inline">
                  <button type="submit" class="text-indigo-600 hover:text-indigo-900">
                    <%= user.active ? 'Deactivate' : 'Activate' %>
                  </button>
                </form>

                <!-- Edit User Modal Trigger -->
                <button
                  onclick="openEditModal('<%= user.id %>', '<%= user.fullName %>', '<%= user.email %>', '<%= user.phone %>', '<%= user.role %>')"
                  class="text-blue-600 hover:text-blue-900"
                >
                  Edit
                </button>

                <!-- Delete User -->
                <form
                  action="/admin/users/<%= user.id %>?_method=DELETE"
                  method="POST"
                  class="inline"
                  onsubmit="return confirm('Are you sure you want to delete this user?')"
                >
                  <button type="submit" class="text-red-600 hover:text-red-900">
                    Delete
                  </button>
                </form>
              </div>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Edit User</h3>
      <form id="editForm" method="POST">
        <input type="hidden" name="_method" value="PUT">
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2">
            Full Name
          </label>
          <input
            type="text"
            name="fullName"
            id="editFullName"
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          />
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2">
            Email
          </label>
          <input
            type="email"
            name="email"
            id="editEmail"
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          />
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2">
            Phone
          </label>
          <input
            type="tel"
            name="phone"
            id="editPhone"
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          />
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2">
            Role
          </label>
          <select
            name="role"
            id="editRole"
            class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          >
            <option value="customer">Customer</option>
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex justify-end space-x-3">
          <button
            type="button"
            onclick="closeEditModal()"
            class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function openEditModal(id, fullName, email, phone, role) {
    document.getElementById('editForm').action = `/admin/users/${id}`;
    document.getElementById('editFullName').value = fullName;
    document.getElementById('editEmail').value = email;
    document.getElementById('editPhone').value = phone;
    document.getElementById('editRole').value = role;
    document.getElementById('editModal').classList.remove('hidden');
  }

  function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
  }
</script>

<%- include('../partials/footer') %> 